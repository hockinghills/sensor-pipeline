# Sensor Pipeline Monitoring Configuration
# Monitors health endpoints and restarts services via systemd --user

check host victoriametrics with address 127.0.0.1
    if failed
        port 8428
        protocol http
        request "/health"
        with timeout 10 seconds
    then exec "/usr/bin/systemctl --user restart victoriametrics"

check host vector with address 127.0.0.1
    if failed
        port 8686
        protocol http
        request "/health"
        with timeout 10 seconds
    then exec "/usr/bin/systemctl --user restart vector"

check host hivemq with address 127.0.0.1
    if failed
        port 1883
        type tcp
        with timeout 10 seconds
    then exec "/usr/bin/systemctl --user restart hivemq"

# Restart vector if victoriametrics restarts (connection refused issue)
check program victoriametrics_vector_dependency with path "/bin/bash -c 'curl -sf http://127.0.0.1:8428/health && curl -sf http://127.0.0.1:8686/health'"
    if status != 0 for 3 cycles
    then exec "/usr/bin/systemctl --user restart vector"
